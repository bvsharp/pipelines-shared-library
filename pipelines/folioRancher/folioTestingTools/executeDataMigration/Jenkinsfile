#!groovy
import org.jenkinsci.plugins.workflow.libs.Library
import org.folio.rest.model.DataMigrationTenant
import java.time.*
import org.folio.rest.GitHubUtility
import org.folio.Constants
import groovy.json.JsonSlurperClassic

@Library('pipelines-shared-library@RANCHER-1223') _
// @Library('pipelines-shared-library@RANCHER-741-Jenkins-Enhancements') _



properties([
    buildDiscarder(logRotator(numToKeepStr: '20')),
    disableConcurrentBuilds(),
    parameters([
        folioParameters.repository(),
        folioParameters.branch( 'FOLIO_BRANCH_SRC',params.FOLIO_REPOSITORY),
        folioParameters.branch('FOLIO_BRANCH_DST', params.FOLIO_REPOSITORY),
        string(name: 'BACKUP_NAME', defaultValue: '', description: '(Optional) RDS snapshot name. If empty create env from scratch', trim: true),
        string(name: 'SLACK_CHANNEL', defaultValue: '', description: 'Slack channel name where send report (without #)', trim: true),
        folioParameters.refreshParameters()
        ])])


def clusterName = 'folio-perf'
def projectName = 'data-migration'
def configType = 'performance'
def tenantId
def adminUsername
def adminPassword
def startMigrationTime = LocalDateTime.now()
Integer totalTimeInMs = 0
LinkedHashMap modulesLongMigrationTimeSlack = [:]
List modulesMigrationFailedSlack = []
def resultMap = [:]
String okapiVersion = folioTools.eval(folioStringScripts.getOkapiVersions(), ['FOLIO_BRANCH': params.FOLIO_BRANCH_SRC])[0]
// def srcInstallJson = new GitHubUtility(this).getEnableList(params.FOLIO_REPOSITORY, params.FOLIO_BRANCH_SRC)
// def dstInstallJson = new GitHubUtility(this).getEnableList(params.FOLIO_REPOSITORY, params.FOLIO_BRANCH_DST)
def srcInstallJson = "[{\"id\":\"okapi-5.1.1\",\"action\":\"enable\"},{\"id\":\"edge-fqm-1.0.0\",\"action\":\"enable\"},{\"id\":\"mod-gobi-2.7.0\",\"action\":\"enable\"},{\"id\":\"mod-rtac-3.5.0\",\"action\":\"enable\"},{\"id\":\"mod-tags-2.1.0\",\"action\":\"enable\"},{\"id\":\"edge-ncip-1.9.2\",\"action\":\"enable\"},{\"id\":\"edge-rtac-2.6.0\",\"action\":\"enable\"},{\"id\":\"edge-sip2-3.1.0\",\"action\":\"enable\"},{\"id\":\"mod-audit-2.8.0\",\"action\":\"enable\"},{\"id\":\"mod-lists-1.0.0\",\"action\":\"enable\"},{\"id\":\"mod-ncip-1.14.3\",\"action\":\"enable\"},{\"id\":\"mod-notes-5.1.0\",\"action\":\"enable\"},{\"id\":\"folio_tags-8.0.2\",\"action\":\"enable\"},{\"id\":\"mod-email-1.16.0\",\"action\":\"enable\"},{\"id\":\"mod-login-7.10.1\",\"action\":\"enable\"},{\"id\":\"mod-notify-3.1.0\",\"action\":\"enable\"},{\"id\":\"mod-patron-6.0.0\",\"action\":\"enable\"},{\"id\":\"mod-search-3.0.0\",\"action\":\"enable\"},{\"id\":\"mod-users-19.2.0\",\"action\":\"enable\"},{\"id\":\"edge-orders-2.9.0\",\"action\":\"enable\"},{\"id\":\"edge-patron-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_lists-2.0.0\",\"action\":\"enable\"},{\"id\":\"folio_notes-9.0.0\",\"action\":\"enable\"},{\"id\":\"mod-copycat-1.5.0\",\"action\":\"enable\"},{\"id\":\"mod-courses-1.4.8\",\"action\":\"enable\"},{\"id\":\"mod-finance-4.8.0\",\"action\":\"enable\"},{\"id\":\"mod-invoice-5.7.0\",\"action\":\"enable\"},{\"id\":\"mod-orders-12.7.1\",\"action\":\"enable\"},{\"id\":\"mod-pubsub-2.11.0\",\"action\":\"enable\"},{\"id\":\"mod-sender-1.11.0\",\"action\":\"enable\"},{\"id\":\"edge-courses-1.3.0\",\"action\":\"enable\"},{\"id\":\"edge-dematic-2.1.0\",\"action\":\"enable\"},{\"id\":\"edge-oai-pmh-2.7.0\",\"action\":\"enable\"},{\"id\":\"folio_orders-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_users-10.0.1\",\"action\":\"enable\"},{\"id\":\"mod-calendar-2.5.0\",\"action\":\"enable\"},{\"id\":\"mod-ebsconet-2.1.0\",\"action\":\"enable\"},{\"id\":\"mod-graphql-1.12.0\",\"action\":\"enable\"},{\"id\":\"mod-licenses-5.0.0\",\"action\":\"enable\"},{\"id\":\"mod-oai-pmh-3.12.0\",\"action\":\"enable\"},{\"id\":\"mod-settings-1.0.1\",\"action\":\"enable\"},{\"id\":\"mod-users-bl-7.6.0\",\"action\":\"enable\"},{\"id\":\"edge-caiasoft-2.1.0\",\"action\":\"enable\"},{\"id\":\"folio_checkin-9.0.0\",\"action\":\"enable\"},{\"id\":\"folio_courses-6.0.2\",\"action\":\"enable\"},{\"id\":\"folio_finance-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_invoice-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_oai-pmh-5.0.0\",\"action\":\"enable\"},{\"id\":\"mod-erm-usage-4.6.0\",\"action\":\"enable\"},{\"id\":\"edge-connexion-1.1.0\",\"action\":\"enable\"},{\"id\":\"folio_requests-9.0.0\",\"action\":\"enable\"},{\"id\":\"mod-agreements-6.0.0\",\"action\":\"enable\"},{\"id\":\"mod-authtoken-2.14.0\",\"action\":\"enable\"},{\"id\":\"mod-feesfines-19.0.0\",\"action\":\"enable\"},{\"id\":\"mod-inventory-20.1.0\",\"action\":\"enable\"},{\"id\":\"mod-login-saml-2.7.0\",\"action\":\"enable\"},{\"id\":\"mod-quick-marc-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_bulk-edit-4.0.0\",\"action\":\"enable\"},{\"id\":\"folio_calendar-10.0.0\",\"action\":\"enable\"},{\"id\":\"folio_checkout-10.0.0\",\"action\":\"enable\"},{\"id\":\"folio_dashboard-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_developer-7.0.0\",\"action\":\"enable\"},{\"id\":\"folio_eholdings-9.0.0\",\"action\":\"enable\"},{\"id\":\"folio_erm-usage-8.0.0\",\"action\":\"enable\"},{\"id\":\"folio_licenses-10.0.0\",\"action\":\"enable\"},{\"id\":\"folio_myprofile-9.0.0\",\"action\":\"enable\"},{\"id\":\"folio_receiving-4.0.0\",\"action\":\"enable\"},{\"id\":\"mod-data-export-4.8.1\",\"action\":\"enable\"},{\"id\":\"mod-data-import-3.0.1\",\"action\":\"enable\"},{\"id\":\"mod-fqm-manager-1.0.0\",\"action\":\"enable\"},{\"id\":\"mod-permissions-6.4.0\",\"action\":\"enable\"},{\"id\":\"mod-user-import-3.8.0\",\"action\":\"enable\"},{\"id\":\"folio_inventory-10.0.0\",\"action\":\"enable\"},{\"id\":\"folio_quick-marc-7.0.1\",\"action\":\"enable\"},{\"id\":\"mod-circulation-24.0.0\",\"action\":\"enable\"},{\"id\":\"mod-event-config-2.6.0\",\"action\":\"enable\"},{\"id\":\"folio_agreements-10.0.0\",\"action\":\"enable\"},{\"id\":\"folio_circulation-9.0.0\",\"action\":\"enable\"},{\"id\":\"folio_data-export-6.0.0\",\"action\":\"enable\"},{\"id\":\"folio_data-import-7.0.0\",\"action\":\"enable\"},{\"id\":\"mod-configuration-5.9.2\",\"action\":\"enable\"},{\"id\":\"mod-kb-ebsco-java-4.0.0\",\"action\":\"enable\"},{\"id\":\"mod-organizations-1.8.0\",\"action\":\"enable\"},{\"id\":\"mod-patron-blocks-1.9.0\",\"action\":\"enable\"},{\"id\":\"mod-entities-links-2.0.0\",\"action\":\"enable\"},{\"id\":\"mod-eusage-reports-2.0.0\",\"action\":\"enable\"},{\"id\":\"mod-remote-storage-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_gobi-settings-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_organizations-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_servicepoints-7.0.0\",\"action\":\"enable\"},{\"id\":\"folio_stripes-core-10.0.0\",\"action\":\"enable\"},{\"id\":\"mod-bulk-operations-1.1.0\",\"action\":\"enable\"},{\"id\":\"mod-finance-storage-8.5.0\",\"action\":\"enable\"},{\"id\":\"mod-invoice-storage-5.7.0\",\"action\":\"enable\"},{\"id\":\"mod-orders-storage-13.6.0\",\"action\":\"enable\"},{\"id\":\"folio_export-manager-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_local-kb-admin-7.0.0\",\"action\":\"enable\"},{\"id\":\"folio_remote-storage-5.0.0\",\"action\":\"enable\"},{\"id\":\"mod-inventory-update-3.2.1\",\"action\":\"enable\"},{\"id\":\"mod-template-engine-1.19.1\",\"action\":\"enable\"},{\"id\":\"folio_circulation-log-4.0.0\",\"action\":\"enable\"},{\"id\":\"folio_erm-comparisons-6.0.0\",\"action\":\"enable\"},{\"id\":\"folio_tenant-settings-8.0.0\",\"action\":\"enable\"},{\"id\":\"folio_marc-authorities-4.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-fund-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-user-7.0.0\",\"action\":\"enable\"},{\"id\":\"mod-data-export-spring-3.0.0\",\"action\":\"enable\"},{\"id\":\"mod-data-export-worker-3.1.0\",\"action\":\"enable\"},{\"id\":\"mod-inventory-storage-27.0.0\",\"action\":\"enable\"},{\"id\":\"mod-password-validator-3.1.0\",\"action\":\"enable\"},{\"id\":\"folio_acquisition-units-5.0.0\",\"action\":\"enable\"},{\"id\":\"mod-erm-usage-harvester-4.4.0\",\"action\":\"enable\"},{\"id\":\"mod-service-interaction-3.0.0\",\"action\":\"enable\"},{\"id\":\"mod-circulation-storage-17.1.0\",\"action\":\"enable\"},{\"id\":\"mod-di-converter-storage-2.1.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-contact-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-po-line-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_service-interaction-2.0.0\",\"action\":\"enable\"},{\"id\":\"mod-organizations-storage-4.6.0\",\"action\":\"enable\"},{\"id\":\"mod-source-record-manager-3.7.0\",\"action\":\"enable\"},{\"id\":\"mod-source-record-storage-5.7.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-bursar-export-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-instance-7.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-license-10.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-query-builder-1.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-eusage-reports-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-authority-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-eresource-6.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-interface-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-agreement-10.0.0\",\"action\":\"enable\"},{\"id\":\"folio_handler-stripes-registry-2.0.1\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-organization-5.0.0\",\"action\":\"enable\"},{\"id\":\"folio_stripes-smart-components-9.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-package-title-6.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-import-profile-7.0.0\",\"action\":\"enable\"},{\"id\":\"folio_stripes-authority-components-3.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-create-inventory-records-4.0.0\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-erm-usage-data-provider-6.0.0\",\"action\":\"enable\"}]"
def dstInstallJson = "[{\"id\":\"folio_developer-9.0.100000580\",\"action\":\"enable\"},{\"id\":\"folio_handler-stripes-registry-2.1.100000122\",\"action\":\"enable\"},{\"id\":\"folio_myprofile-9.0.100000302\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-authority-4.0.100000528\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-fund-3.0.100000135\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-package-title-6.0.100000271\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-user-7.0.100000378\",\"action\":\"enable\"},{\"id\":\"folio_plugin-query-builder-1.0.100000676\",\"action\":\"enable\"},{\"id\":\"folio_requests-mediated-1.1.10000068\",\"action\":\"enable\"},{\"id\":\"folio_servicepoints-7.1.100000219\",\"action\":\"enable\"},{\"id\":\"mod-permissions-6.5.0-SNAPSHOT.173\",\"action\":\"enable\"},{\"id\":\"mod-batch-print-1.0.1-SNAPSHOT.9\",\"action\":\"enable\"},{\"id\":\"mod-di-converter-storage-2.2.0-SNAPSHOT.38\",\"action\":\"enable\"},{\"id\":\"mod-graphql-1.12.1000348\",\"action\":\"enable\"},{\"id\":\"mod-requests-mediated-1.0.0-SNAPSHOT.5\",\"action\":\"enable\"},{\"id\":\"mod-settings-1.1.0-SNAPSHOT.36\",\"action\":\"enable\"},{\"id\":\"mod-tlr-1.0.0-SNAPSHOT.12\",\"action\":\"enable\"},{\"id\":\"mod-orders-storage-13.7.0-SNAPSHOT.344\",\"action\":\"enable\"},{\"id\":\"mod-erm-usage-4.7.0-SNAPSHOT.184\",\"action\":\"enable\"},{\"id\":\"mod-tags-2.1.1-SNAPSHOT.105\",\"action\":\"enable\"},{\"id\":\"folio_tags-8.0.200000236\",\"action\":\"enable\"},{\"id\":\"mod-organizations-storage-4.7.0-SNAPSHOT.100\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-contact-5.0.100000140\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-interface-5.0.100000126\",\"action\":\"enable\"},{\"id\":\"mod-organizations-1.9.0-SNAPSHOT.55\",\"action\":\"enable\"},{\"id\":\"mod-finance-storage-8.6.0-SNAPSHOT.334\",\"action\":\"enable\"},{\"id\":\"mod-service-interaction-3.1.0-SNAPSHOT.106\",\"action\":\"enable\"},{\"id\":\"folio_dashboard-5.1.100000552\",\"action\":\"enable\"},{\"id\":\"folio_service-interaction-2.1.100000188\",\"action\":\"enable\"},{\"id\":\"mod-calendar-2.6.0-SNAPSHOT.155\",\"action\":\"enable\"},{\"id\":\"mod-invoice-storage-5.8.0-SNAPSHOT.146\",\"action\":\"enable\"},{\"id\":\"mod-licenses-5.1.0-SNAPSHOT.246\",\"action\":\"enable\"},{\"id\":\"folio_licenses-10.1.100000598\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-license-10.1.100000265\",\"action\":\"enable\"},{\"id\":\"mod-ldp-1.1.3-SNAPSHOT.47\",\"action\":\"enable\"},{\"id\":\"folio_ldp-2.0.100000475\",\"action\":\"enable\"},{\"id\":\"mod-source-record-storage-5.8.0-SNAPSHOT.578\",\"action\":\"enable\"},{\"id\":\"mod-users-19.3.0-SNAPSHOT.286\",\"action\":\"enable\"},{\"id\":\"mod-inventory-storage-27.1.0-SNAPSHOT.941\",\"action\":\"enable\"},{\"id\":\"folio_calendar-10.0.100000960\",\"action\":\"enable\"},{\"id\":\"mod-inventory-update-3.2.2-SNAPSHOT.113\",\"action\":\"enable\"},{\"id\":\"mod-courses-1.4.9-SNAPSHOT.158\",\"action\":\"enable\"},{\"id\":\"folio_courses-6.1.100000319\",\"action\":\"enable\"},{\"id\":\"mod-password-validator-3.1.1-SNAPSHOT.82\",\"action\":\"enable\"},{\"id\":\"mod-login-7.11.0-SNAPSHOT.144\",\"action\":\"enable\"},{\"id\":\"edge-courses-1.3.2-SNAPSHOT.11\",\"action\":\"enable\"},{\"id\":\"edge-inn-reach-3.1.1-SNAPSHOT.50\",\"action\":\"enable\"},{\"id\":\"mod-circulation-item-1.0.0-SNAPSHOT.30\",\"action\":\"enable\"},{\"id\":\"mod-erm-usage-harvester-4.5.0-SNAPSHOT.174\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-erm-usage-data-provider-6.0.100000162\",\"action\":\"enable\"},{\"id\":\"mod-pubsub-2.13.0-SNAPSHOT.235\",\"action\":\"enable\"},{\"id\":\"mod-circulation-storage-17.2.0-SNAPSHOT.399\",\"action\":\"enable\"},{\"id\":\"mod-fqm-manager-1.1.0-SNAPSHOT.121\",\"action\":\"enable\"},{\"id\":\"edge-fqm-1.1.0-SNAPSHOT.21\",\"action\":\"enable\"},{\"id\":\"mod-lists-1.1.0-SNAPSHOT.59\",\"action\":\"enable\"},{\"id\":\"folio_lists-2.0.600000640\",\"action\":\"enable\"},{\"id\":\"mod-rtac-3.6.0-SNAPSHOT.83\",\"action\":\"enable\"},{\"id\":\"edge-rtac-2.7.0-SNAPSHOT.89\",\"action\":\"enable\"},{\"id\":\"mod-user-import-3.9.0-SNAPSHOT.94\",\"action\":\"enable\"},{\"id\":\"mod-patron-blocks-1.10.0-SNAPSHOT.96\",\"action\":\"enable\"},{\"id\":\"mod-serials-management-1.0.0-SNAPSHOT.65\",\"action\":\"enable\"},{\"id\":\"folio_serials-management-1.0.100000720\",\"action\":\"enable\"},{\"id\":\"mod-agreements-6.1.0-SNAPSHOT.638\",\"action\":\"enable\"},{\"id\":\"folio_erm-comparisons-6.1.100000451\",\"action\":\"enable\"},{\"id\":\"folio_local-kb-admin-7.1.100000531\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-agreement-10.1.100000292\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-eresource-6.1.100000272\",\"action\":\"enable\"},{\"id\":\"mod-authtoken-2.15.0-SNAPSHOT.146\",\"action\":\"enable\"},{\"id\":\"mod-configuration-5.9.3-SNAPSHOT.129\",\"action\":\"enable\"},{\"id\":\"folio_agreements-10.1.1000001384\",\"action\":\"enable\"},{\"id\":\"folio_erm-usage-8.0.100000383\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-organization-5.1.100000198\",\"action\":\"enable\"},{\"id\":\"mod-oai-pmh-3.13.0-SNAPSHOT.344\",\"action\":\"enable\"},{\"id\":\"folio_oai-pmh-5.0.100000279\",\"action\":\"enable\"},{\"id\":\"edge-oai-pmh-2.8.0-SNAPSHOT.104\",\"action\":\"enable\"},{\"id\":\"mod-users-bl-7.6.1-SNAPSHOT.145\",\"action\":\"enable\"},{\"id\":\"folio_stripes-core-10.1.1000001924\",\"action\":\"enable\"},{\"id\":\"mod-finance-4.9.0-SNAPSHOT.235\",\"action\":\"enable\"},{\"id\":\"mod-notes-5.2.0-SNAPSHOT.234\",\"action\":\"enable\"},{\"id\":\"folio_notes-9.0.100000282\",\"action\":\"enable\"},{\"id\":\"folio_stripes-smart-components-9.1.1000002119\",\"action\":\"enable\"},{\"id\":\"mod-source-record-manager-3.8.0-SNAPSHOT.870\",\"action\":\"enable\"},{\"id\":\"mod-copycat-1.6.0-SNAPSHOT.94\",\"action\":\"enable\"},{\"id\":\"edge-connexion-1.2.0-SNAPSHOT.30\",\"action\":\"enable\"},{\"id\":\"mod-entities-links-3.0.0-SNAPSHOT.230\",\"action\":\"enable\"},{\"id\":\"folio_stripes-marc-components-1.0.10000030\",\"action\":\"enable\"},{\"id\":\"mod-marc-migrations-1.0.0-SNAPSHOT.26\",\"action\":\"enable\"},{\"id\":\"mod-search-3.2.0-SNAPSHOT.474\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-instance-7.0.400000568\",\"action\":\"enable\"},{\"id\":\"folio_stripes-authority-components-4.0.100000835\",\"action\":\"enable\"},{\"id\":\"mod-inventory-20.2.0-SNAPSHOT.715\",\"action\":\"enable\"},{\"id\":\"mod-quick-marc-5.1.0-SNAPSHOT.237\",\"action\":\"enable\"},{\"id\":\"folio_marc-authorities-5.0.1000006844\",\"action\":\"enable\"},{\"id\":\"folio_quick-marc-8.0.1000002242\",\"action\":\"enable\"},{\"id\":\"mod-data-export-4.9.0-SNAPSHOT.385\",\"action\":\"enable\"},{\"id\":\"folio_data-export-6.0.100000590\",\"action\":\"enable\"},{\"id\":\"mod-kb-ebsco-java-4.1.0-SNAPSHOT.394\",\"action\":\"enable\"},{\"id\":\"folio_eholdings-9.1.1000001120\",\"action\":\"enable\"},{\"id\":\"mod-login-saml-2.8.0-SNAPSHOT.130\",\"action\":\"enable\"},{\"id\":\"folio_tenant-settings-8.0.100000800\",\"action\":\"enable\"},{\"id\":\"mod-template-engine-1.19.2-SNAPSHOT.94\",\"action\":\"enable\"},{\"id\":\"mod-audit-2.9.0-SNAPSHOT.162\",\"action\":\"enable\"},{\"id\":\"folio_circulation-log-4.0.100000366\",\"action\":\"enable\"},{\"id\":\"mod-data-import-3.1.0-SNAPSHOT.284\",\"action\":\"enable\"},{\"id\":\"folio_data-import-7.0.5000002296\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-import-profile-7.0.100000217\",\"action\":\"enable\"},{\"id\":\"mod-event-config-2.6.1-SNAPSHOT.64\",\"action\":\"enable\"},{\"id\":\"mod-email-1.16.1-SNAPSHOT.83\",\"action\":\"enable\"},{\"id\":\"mod-sender-1.11.1-SNAPSHOT.48\",\"action\":\"enable\"},{\"id\":\"mod-notify-3.1.1-SNAPSHOT.131\",\"action\":\"enable\"},{\"id\":\"mod-feesfines-19.1.0-SNAPSHOT.225\",\"action\":\"enable\"},{\"id\":\"mod-circulation-24.2.0-SNAPSHOT.1221\",\"action\":\"enable\"},{\"id\":\"folio_checkin-9.1.100000746\",\"action\":\"enable\"},{\"id\":\"folio_checkout-10.1.100000968\",\"action\":\"enable\"},{\"id\":\"folio_circulation-9.1.1000001971\",\"action\":\"enable\"},{\"id\":\"folio_inventory-11.0.1000006363\",\"action\":\"enable\"},{\"id\":\"folio_plugin-create-inventory-records-4.0.100000402\",\"action\":\"enable\"},{\"id\":\"folio_requests-9.1.1000002477\",\"action\":\"enable\"},{\"id\":\"folio_users-10.1.1000005020\",\"action\":\"enable\"},{\"id\":\"edge-sip2-3.2.0-SNAPSHOT.131\",\"action\":\"enable\"},{\"id\":\"mod-dcb-1.1.0-SNAPSHOT.67\",\"action\":\"enable\"},{\"id\":\"edge-dcb-1.1.0-SNAPSHOT.14\",\"action\":\"enable\"},{\"id\":\"mod-ncip-1.14.5-SNAPSHOT.80\",\"action\":\"enable\"},{\"id\":\"edge-ncip-1.9.3-SNAPSHOT.31\",\"action\":\"enable\"},{\"id\":\"mod-patron-6.1.0-SNAPSHOT.122\",\"action\":\"enable\"},{\"id\":\"edge-patron-5.1.0-SNAPSHOT.110\",\"action\":\"enable\"},{\"id\":\"mod-orders-12.8.0-SNAPSHOT.785\",\"action\":\"enable\"},{\"id\":\"folio_acquisition-units-5.0.100000191\",\"action\":\"enable\"},{\"id\":\"folio_plugin-find-po-line-5.0.100000164\",\"action\":\"enable\"},{\"id\":\"folio_receiving-5.0.100000576\",\"action\":\"enable\"},{\"id\":\"mod-data-export-spring-3.2.0-SNAPSHOT.263\",\"action\":\"enable\"},{\"id\":\"folio_export-manager-3.0.100000434\",\"action\":\"enable\"},{\"id\":\"folio_organizations-5.1.100000652\",\"action\":\"enable\"},{\"id\":\"folio_plugin-bursar-export-3.1.100000322\",\"action\":\"enable\"},{\"id\":\"mod-data-export-worker-3.2.0-SNAPSHOT.458\",\"action\":\"enable\"},{\"id\":\"mod-bulk-operations-2.0.0-SNAPSHOT.183\",\"action\":\"enable\"},{\"id\":\"folio_bulk-edit-4.0.1000002276\",\"action\":\"enable\"},{\"id\":\"mod-ebsconet-2.2.0-SNAPSHOT.75\",\"action\":\"enable\"},{\"id\":\"mod-eusage-reports-2.1.0-SNAPSHOT.181\",\"action\":\"enable\"},{\"id\":\"folio_plugin-eusage-reports-3.0.100000273\",\"action\":\"enable\"},{\"id\":\"mod-gobi-2.8.0-SNAPSHOT.224\",\"action\":\"enable\"},{\"id\":\"folio_gobi-settings-3.0.100000337\",\"action\":\"enable\"},{\"id\":\"edge-orders-2.10.0-SNAPSHOT.65\",\"action\":\"enable\"},{\"id\":\"mod-invoice-5.8.0-SNAPSHOT.403\",\"action\":\"enable\"},{\"id\":\"folio_finance-6.0.100000678\",\"action\":\"enable\"},{\"id\":\"folio_invoice-6.0.100000823\",\"action\":\"enable\"},{\"id\":\"folio_orders-6.0.1000001111\",\"action\":\"enable\"},{\"id\":\"mod-remote-storage-3.2.0-SNAPSHOT.200\",\"action\":\"enable\"},{\"id\":\"folio_remote-storage-5.0.100000240\",\"action\":\"enable\"},{\"id\":\"edge-caiasoft-2.1.1-SNAPSHOT.36\",\"action\":\"enable\"},{\"id\":\"edge-dematic-3.0.0-SNAPSHOT.68\",\"action\":\"enable\"},{\"id\":\"mod-inn-reach-3.2.0-SNAPSHOT.348\",\"action\":\"enable\"},{\"id\":\"folio_inn-reach-4.0.100000401\",\"action\":\"enable\"},{\"id\":\"mod-oa-2.1.0-SNAPSHOT.173\",\"action\":\"enable\"},{\"id\":\"folio_oa-2.1.1000001003\",\"action\":\"enable\"}]"
def pgadminURL = "https://${clusterName}-${projectName}-pgadmin.ci.folio.org/"

ansiColor('xterm') {
    if (params.refresh_parameters) {
        currentBuild.result = 'ABORTED'
        println('REFRESH JOB PARAMETERS!')
        return
    }
    node('rancher') {
        try {
            stage('Init') {
                currentBuild.result = 'SUCCESS'
                if (params.BACKUP_NAME) {
                    tenantId = 'fs09000000'
                    adminUsername = 'folio'
                    adminPassword = 'folio'
                    buildName tenantId + '-' + params.BACKUP_NAME + '.' + env.BUILD_ID
                } else {
                    tenantId = 'diku'
                    adminUsername = 'diku'
                    adminPassword = 'diku_admin'
                    buildName tenantId + '.' + 'without-restore' + '.' + env.BUILD_ID
                }


            }

          // stage('Destroy data-migration project') {
          //   def jobParameters = getEnvironmentJobParameters(
          //     'destroy',
          //     clusterName,
          //     projectName,
          //     params.FOLIO_REPOSITORY,
          //     params.FOLIO_BRANCH_SRC,
          //     okapiVersion,
          //     tenantId,
          //     adminUsername,
          //     adminPassword,
          //     params.BACKUP_NAME)

          //   build job: Constants.JENKINS_JOB_PROJECT, parameters: jobParameters, wait: true, propagate: false
          // }

          // stage('Restore data-migration project from backup') {
          //   if (params.BACKUP_NAME) {
          //     def jobParameters = getEnvironmentJobParameters(
          //       'apply',
          //       clusterName,
          //       projectName,
          //       params.FOLIO_REPOSITORY,
          //       params.FOLIO_BRANCH_SRC,
          //       okapiVersion,
          //       tenantId,
          //       adminUsername,
          //       adminPassword,
          //       params.BACKUP_NAME,
          //       true)

          //     build job: Constants.JENKINS_JOB_PROJECT, parameters: jobParameters, wait: true, propagate: false
          //   }
          // }

          // stage('Create data-migration project') {
          //   if (!params.BACKUP_NAME) {
          //     def jobParameters = getEnvironmentJobParameters(
          //       'apply',
          //       clusterName,
          //       projectName,
          //       params.FOLIO_REPOSITORY,
          //       params.FOLIO_BRANCH_SRC,
          //       okapiVersion,
          //       tenantId,
          //       adminUsername,
          //       adminPassword,
          //       params.BACKUP_NAME,
          //       false,
          //       true,
          //       true,
          //       true)

          //     build job: Constants.JENKINS_JOB_PROJECT, parameters: jobParameters, wait: true, propagate: false
          //   }
          // }

            // stage('Update with dst release versions') {
            //     build job: Constants.JENKINS_JOB_BACKEND_MODULES_DEPLOY_BRANCH,
            //         parameters: [
            //             string(name: 'folio_repository', value: params.FOLIO_REPOSITORY),
            //             string(name: 'folio_branch', value: params.FOLIO_BRANCH_DST),
            //             string(name: 'rancher_cluster_name', value: clusterName),
            //             string(name: 'rancher_project_name', value: projectName),
            //             string(name: 'config_type', value: configType),
            //             string(name: 'tenant_id', value: tenantId),
            //             string(name: 'admin_username', value: adminUsername),
            //             string(name: 'admin_password', value: adminPassword)
            //         ]
            // }


            stage('Generate Data Migration Time report') {
                def result = folioexecuteDataMigrationUtils.getMigrationTime(
                    clusterName,
                    projectName,
                    resultMap,
                    srcInstallJson,
                    dstInstallJson,
                    totalTimeInMs,
                    modulesLongMigrationTimeSlack,
                    modulesMigrationFailedSlack,
                    startMigrationTime,
                    pgadminURL
                )
              totalTimeInMs += result[0]
              modulesLongMigrationTimeSlack += result[1]
              modulesMigrationFailedSlack += result[2]
            }



        } catch (exception) {
            currentBuild.result = 'FAILURE'
            error(exception.getMessage())
        } finally {
            stage('Publish HTML Reports') {
                publishHTML([
                    reportDir: 'reportTime',
                    reportFiles: '*.html',
                    reportName: 'Data Migration Time',
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true])
            }

          //  stage('Send Slack notification') {
          //      folioexecuteDataMigrationUtils.sendSlackNotification("#${params.SLACK_CHANNEL}",totalTimeInMs, modulesLongMigrationTimeSlack, modulesMigrationFailedSlack)
          //  }

          // stage('Destroy data-migration project') {
          //   def jobParameters = getEnvironmentJobParameters(
          //     'destroy',
          //     clusterName,
          //     projectName,
          //     params.FOLIO_REPOSITORY,
          //     params.FOLIO_BRANCH_SRC,
          //     okapiVersion,
          //     tenantId,
          //     adminUsername,
          //     adminPassword,
          //     params.BACKUP_NAME)

          //   build job: Constants.JENKINS_JOB_PROJECT, parameters: jobParameters, wait: true, propagate: false
          // }

            stage('Cleanup') {
                cleanWs notFailBuild: true
            }
        }
    }
}


private List getEnvironmentJobParameters(String action,
                                         String clusterName,
                                         String projectName,
                                         String folioRepository,
                                         String folioBranch,
                                         String okapiVersion,
                                         String tenantId,
                                         String adminUsername,
                                         String adminPassword,
                                         String backupName,
                                         boolean restoreFromBackup = false,
                                         boolean loadReference = false,
                                         boolean loadSample = false,
                                         boolean pgEmbedded = false,
                                         boolean kafkaShared = true,
                                         boolean opensearchShared = true,
                                         boolean s3Embedded = false) {
  [
    string(name: 'action', value: action),
    string(name: 'rancher_cluster_name', value: clusterName),
    string(name: 'rancher_project_name', value: projectName),
    string(name: 'folio_repository', value: folioRepository),
    string(name: 'folio_branch', value: folioBranch),
    string(name: 'okapi_version', value: okapiVersion),
    string(name: 'config_type', value: 'performance'),
    string(name: 'tenant_id', value: tenantId),
    string(name: 'admin_username', value: adminUsername),
    string(name: 'admin_password', value: adminPassword),
    string(name: 'backup_type', value: 'rds'),
    string(name: 'backup_name', value: backupName),
    booleanParam(name: 'restore_from_backup', value: restoreFromBackup),
    booleanParam(name: 'load_reference', value: loadReference),
    booleanParam(name: 'load_sample', value: loadSample),
    booleanParam(name: 'pg_embedded', value: pgEmbedded),
    booleanParam(name: 'kafka_shared', value: kafkaShared),
    booleanParam(name: 'opensearch_shared', value: opensearchShared),
    booleanParam(name: 's3_embedded', value: s3Embedded)
  ]
}
